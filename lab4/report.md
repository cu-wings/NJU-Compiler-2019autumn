# <center>编译原理实验报告</center>

<center>171860570_周吴成，161220144向扬帆</center>
### 1.实验目标

在词法分析、语法分析和语义分析后生成的中间代码的基础上编写一个程序，将C--源代码翻译为目标代码MIPS32指令。

### 2.实验内容

1. 目标代码分块
   + 首先，为了完成寄存器的分配，我们在这里选择使用局部寄存器分配算法，因此我们需要将中间代码分块，每个基本块中指令均为顺序执行。由于需要知道一个函数中每个变量在内存中存放的位置，那么需要对每个函数都记录下其所有的变量，我们使用的方式是将中间代码按函数分块，每个函数再分为数个基本块。
   
     ![结构](D:\课件\作业\大三上\编译原理\实验四\结构.png)
     
     每个函数块记录其所有的变量以及这些变量的总偏移量（用于分配栈帧空间），每个基本块记录在基本块中出现的变量，以及每个变量出现的位置（只记录在当前基本块中的出现行数），同时变量描述符中记录给这个变量分配的寄存器和该变量相对于fp的偏移量。
     
     在拆分基本块时，一个基本块的开头一条语句除了是goto、label、ifgoto的下一条之外，还有可能是ret语句的下一条。特别的，call语句作为一个基本块的结束语句，由于在进入一个函数调用前需要保存当前函数中使用的所有变量，因此将call语句也作为一个基本块的结束语句，且保存变量的工作需要在call之前完成。
   
2. 寄存器分配算法
   
     + 由于使用的是局部寄存器分配算法，在基本块中使用一个变量之前，需要将其从内存载入寄存器，而从基本块离开时，需要将当前基本块使用过的所有变量存回内存中。由于记录了所有变量下一次使用的位置，因此在分配寄存器时如果不够，则将下一次使用位置最远的（或是没有下一次使用）的变量存回内存，再分配寄存器。
     
     + 寄存器的结构是一个bool型数组，只记录每个寄存器是否空闲。当为一个变量分配寄存器时，首先会判断该变量是否已经分配寄存器，然后再寻找是否有空闲寄存器。
     
     + 当为一个常数分配寄存器时，会为该常数临时分配一个寄存器，在该语句结束后，会将这个常数的寄存器释放以供其他变量使用。
     
     + 当一个变量需要取其地址或是取值时，在这里用了一种折中的方式，由于一个变量只对应与一个偏移量或是寄存器，因此所有取值和取地址都会临时存入一个不会被分配使用的寄存器，由于一条目标指令只会有最多三个操作数，因此将v1和t8、t9三个寄存器分别制定为用于一条目标指令中第一、第二、第三个操作数取值或是取地址时存入的寄存器，注意这三个寄存器中的值不会被存入内存，只是临时变量，因此每次取值或是取地址都需要先将值或地址存入这三个寄存器再进行操作。
     
     + 按照MIPS32的规定，a0-a3用于函数的前四个参数，由于在函数开头时就会通过PRARM语句将这些参数传入函数内的变量中，因此a0-a3不需要进行保存，需要进行保存的寄存器只有t0-t7和s0-s7。
     
     + 由于采用了局部寄存器分配算法，因此t0-t7和s0-s7没有本质的区别，所以它们能够被自由地分配给任意变量，无需考虑由谁来保存它们。因此，在一个函数返回（RET）时，不需要保存任何的寄存器，只需要将所有寄存器都释放即可。
     
       
     
3. 函数栈帧构造

   + 函数的栈帧结构采取了与x86指令类似的结构，栈帧最上方是该函数的大于四个的参数，接着是返回地址，fp旧值，下方是这个函数中出现的所有变量的存储空间，每个变量相对于fp有固定的偏移量，偏移量的值在函数分块的步骤中就已经记录完毕了。
   + 对于数组这样需要占据超过4字节的空间的变量，由于DEC语句为其分配了相应的空间，因此在函数分块时，就对这样的变量分配相应的空间，注意数组的首地址靠向栈顶，在取数组中元素时的寄存器分配问题在上一步中已经说明，此处不再赘述。
   + 进入一个函数时，首先需要将sp减去栈帧的大小（记录在函数块中），其次将返回地址、fp旧值依次压入栈中，在离开函数时，同样需要将sp加上栈帧的大小，弹出fp旧值、弹出返回地址。
   + 在调用函数时，函数的参数小于4个的直接存入a0-a3，大于4个时依次压入栈中，由于在中间代码步骤时传入参数的顺序与源代码相反，因此生成目标代码时，在函数获取形参时（也就是解析PARAM语句时）需要再次取相反的顺序。

   


4. 其他

   本小组为第10组。

   编译方式与原本编译方式一致，Makefile文件中添加了scanner的伪目标。

### 3.小组成员

周吴成 171860570 邮箱：zwx847447133@126.com

向扬帆 161220144 邮箱：272338868@qq.com